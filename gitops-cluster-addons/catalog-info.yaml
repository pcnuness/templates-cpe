apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: gitops-cluster-addons
  title: Repoitorio GitOps customizado com Add-ons
  description: Criação de estrutura GitOps com escolha de Add-ons
  annotations:
    backstage.io/managed-by-location: https://github.com/pcnuness/templates-cpe/blob/main/catalog-info.yaml
spec:
  owner: gitops-plataform
  type: gitops

  parameters:
    - title: Parâmetros da estrutura
      required: [projectName, owner]
      properties:
        projectName:
          title: Nome do Repositório
          type: string
          default: gitops-cluster
        owner:
          title: Organização ou Usuário GitHub
          type: string
          default: pcnuness
    - title: Selecione Addons
      type: object
      properties:
        aws-alb-controller:
          type: boolean
          title: Incluir AWS-Load-Balancer-Controller
          default: true
        ingressNginx:
          type: boolean
          title: Incluir Ingress-Nginx
          default: true
        keda:
          type: boolean
          title: Incluir KEDA
          default: false

  steps:
    #- id: fetch-template
    #  name: Gerar estrutura GitOps com Addons
    #  action: fetch:template
    #  input:
    #    targetPath: "."
    #    url: "./templates"
    #    values:
    #      projectName: ${{ parameters.projectName }}
    #      owner: ${{ parameters.owner }}
    #      addons: ${{ parameters.addons }}
    - id: fetch-base
      name: Buscar estrutura base
      action: fetch:template
      input:
        url: ./templates/cluster-management
        targetPath: .
        values:
          projectName: ${{ parameters.projectName }}
          owner: ${{ parameters.owner }}

    - id: alb-controller
      name: Gerar AWS ALB Controller
      action: fetch:template
      when: ${{ parameters.aws-alb-controller }}
      input:
        url: ./templates/addons/aws/
        targetPath: ./cluster-management/bootstraps/control-plane/addons/aws/
        values:
          projectName: ${{ parameters.projectName }}
  
    - id: ingress-nginx
      name: Gerar Ingress NGINX
      action: fetch:template
      when: ${{ parameters.ingressNginx }}
      input:
        url: ./templates/addons/oss/
        targetPath: ./cluster-management/bootstraps/control-plane/addons/oss/
        values:
          projectName: ${{ parameters.projectName }}

    - id: keda
      name: Gerar Addon Keda
      action: fetch:template
      when: ${{ parameters.keda }}
      input:
        url: ./templates/addons/oss/
        targetPath: ./cluster-management/bootstraps/control-plane/addons/oss/keda.yaml
        values:
          projectName: ${{ parameters.projectName }}

    - id: push-initial
      name: Push Inicial
      action: publish:github
      input:
        repoUrl: "github.com?owner=${{ parameters.owner }}&repo=${{ parameters.projectName }}"
        branch: main
        defaultBranch: main
        repoVisibility: public
        committerName: "Backstage Scaffolder"
        committerEmail: "scaffolder@mydomain.com"
        authorName: "Backstage Scaffolder"
        authorEmail: "scaffolder@mydomain.com"
        commitMessage: "Initial commit from Scaffolder"
        files:
          - source: "."
            target: "/"

  output:
    links:
      - title: Repositório GitHub
        url: "https://github.com/${{ parameters.owner }}/${{ parameters.projectName }}"
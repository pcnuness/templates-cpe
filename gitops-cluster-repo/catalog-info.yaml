apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: gitops-cluster-repo
  title: Novo Repositório GitOps de Gerenciamento de Cluster
  description: Cria um novo repositório GitOps com a estrutura padrão para gerenciamento de cluster por cliente, aplicação ou produto.
  tags:
    - gitops
    - argocd
    - kubernetes
    - backstage
    - aws
    - github
spec:
  owner: gitops-plataform
  type: gitops

  parameters:
    - title: GitOps Repository Details
      required: [projectName, owner]
      properties:
        projectName:
          title: Nome do Repositório GitOps
          type: string
          default: cluster-management
        owner:
          title: Organização ou Usuário no GitHub
          type: string
          default: pcnunes

    - title: Configuração de Addons
      properties:
        addonsAWS:
          title: Selecione Add-ons AWS
          type: array
          items:
            type: string
            enum:
              - load-balancer-controller
              - external-dns
              - ebs-csi-driver
          default: ["load-balancer-controller"]
        addonsOSS:
          title: Selecione Add-ons OSS
          type: array
          items:
            type: string
            enum:
              - crossplane
              - ingress-nginx
              - argocd-ingress
          default: ["crossplane"]

  steps:
    - id: fetch-base
      name: Gerar estrutura base GitOps
      action: fetch:template
      input:
        targetPath: "."
        url: "./templates/base"
        values:
          projectName: ${{ parameters.projectName }}
          owner: ${{ parameters.owner }}

    # AWS Addons
    - id: fetch-addon-aws-lb
      name: Adicionar AWS Load Balancer Controller
      if: ${{ parameters.addonsAWS && "load-balancer-controller" in parameters.addonsAWS }}
      action: fetch:template
      input:
        targetPath: "cluster-management/bootstraps/control-plane/addons/aws"
        url: "./templates/addons/aws/load-balancer-controller"
        values: {}

    - id: fetch-addon-aws-extdns
      name: Adicionar External DNS
      if: ${{ parameters.addonsAWS && "external-dns" in parameters.addonsAWS }}
      action: fetch:template
      input:
        targetPath: "cluster-management/bootstraps/control-plane/addons/aws"
        url: "./templates/addons/aws/external-dns"
        values: {}

    - id: fetch-addon-aws-ebs
      name: Adicionar EBS CSI Driver
      if: ${{ parameters.addonsAWS && "ebs-csi-driver" in parameters.addonsAWS }}
      action: fetch:template
      input:
        targetPath: "cluster-management/bootstraps/control-plane/addons/aws"
        url: "./templates/addons/aws/ebs-csi-driver"
        values: {}

    # OSS Addons
    - id: fetch-addon-oss-crossplane
      name: Adicionar Crossplane
      if: ${{ parameters.addonsOSS && "crossplane" in parameters.addonsOSS }}
      action: fetch:template
      input:
        targetPath: "cluster-management/bootstraps/control-plane/addons/oss"
        url: "./templates/addons/oss/crossplane"
        values: {}

    - id: fetch-addon-oss-ingress
      name: Adicionar Ingress NGINX
      if: ${{ parameters.addonsOSS && "ingress-nginx" in parameters.addonsOSS }}
      action: fetch:template
      input:
        targetPath: "cluster-management/bootstraps/control-plane/addons/oss"
        url: "./templates/addons/oss/ingress-nginx"
        values: {}

    - id: fetch-addon-oss-argocd
      name: Adicionar ArgoCD Ingress
      if: ${{ parameters.addonsOSS && "argocd-ingress" in parameters.addonsOSS }}
      action: fetch:template
      input:
        targetPath: "cluster-management/bootstraps/control-plane/addons/oss"
        url: "./templates/addons/oss/argocd-ingress"
        values: {}

    - id: push-initial
      name: Push Inicial
      action: publish:github
      input:
        repoUrl: "github.com?owner=${{ parameters.owner }}&repo=${{ parameters.projectName }}"
        branch: main
        defaultBranch: main
        committerName: "Backstage Scaffolder"
        committerEmail: "scaffolder@mydomain.com"
        authorName: "Backstage Scaffolder"
        authorEmail: "scaffolder@mydomain.com"
        commitMessage: "Initial commit from Scaffolder"
        files:
          - source: "."
            target: "/"

  output:
    links:
      - title: Repositório no GitHub
        url: "https://github.com/${{ parameters.owner }}/${{ parameters.projectName }}"
        text: "Acesse o repositório criado"
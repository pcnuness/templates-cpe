apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: adicionar-addons-gitops
  title: Adicionar Addons GitOps
  description: Adiciona addons em reposit√≥rio GitOps existente via Pull Request
  tags:
    - kubernetes
    - gitops
    - addons
    - pull-request
spec:
  owner: plataforma-gitops
  type: service
  parameters:
    - title: Configura√ß√µes do Reposit√≥rio
      required:
        - repositoryPicker
      properties:
        repositoryPicker:
          title: Selecionar Reposit√≥rio GitOps
          type: string
          description: Selecione o reposit√≥rio GitOps existente
          ui:field: RepoUrlPicker
          ui:options:
            allowedHosts:
              - github.com
            allowedOwners:
              - pcnuness
              - sua-org
              - outra-org
        targetBranch:
          title: Branch Base
          type: string
          description: Branch base para criar o PR
          default: main
        prTitle:
          title: T√≠tulo do Pull Request
          type: string
          description: T√≠tulo personalizado para o PR
          default: "feat: Adicionar addons GitOps via Backstage"

    - title: Sele√ß√£o de Addons AWS
      properties:
        enableAwsAlbController:
          title: AWS Load Balancer Controller
          type: boolean
          description: AWS Application Load Balancer Controller
          default: false
        
    - title: Sele√ß√£o de Addons OSS
      properties:
        enableIngressNginx:
          title: Ingress NGINX
          type: boolean
          description: Ingress NGINX Controller
          default: false
        enableArgoCdIngress:
          title: ArgoCD Ingress
          type: boolean
          description: Configura√ß√£o de Ingress para ArgoCD
          default: false
        enableCrossplane:
          title: Crossplane
          type: boolean
          description: Crossplane para gerenciamento de infraestrutura
          default: false
        enableKarpenter:
          title: Karpenter
          type: boolean
          description: Karpenter para autoscaling de Nodes
          default: false
        enableKubePrometheusStack:
          title: Kube Prometheus Stack
          type: boolean
          description: Stack de monitoramento Prometheus
          default: false
        enableMetricsServer:
          title: Metrics Server
          type: boolean
          description: Metrics Server para monitoramento
          default: false

    - title: Configura√ß√µes de Aprova√ß√£o
      properties:
        requiresApproval:
          title: Requer Aprova√ß√£o
          type: boolean
          description: PR requer aprova√ß√£o antes do merge
          default: true
        reviewers:
          title: Revisores
          type: array
          description: Lista de usu√°rios/equipes para revisar o PR
          items:
            type: string
          default: ["@plataforma-gitops", "@devops-team"]
        priority:
          title: Prioridade
          type: string
          description: Prioridade da mudan√ßa
          enum:
            - low
            - medium
            - high
            - critical
          enumNames:
            - Baixa
            - M√©dia
            - Alta
            - Cr√≠tica
          default: medium
        createDraft:
          title: Criar como Draft
          type: boolean
          description: Criar PR como draft (exceto para prioridade cr√≠tica)
          default: true

  steps:
    - id: fetch-repository
      name: Clonar Reposit√≥rio Existente
      action: fetch:plain
      input:
        url: ${{ parameters.repositoryPicker | parseRepoUrl | pick('repo') }}
        targetPath: ./repo

    # STEPS PARA ADICIONAR ADDONS
    - id: fetch-aws-alb-controller
      name: Adicionar AWS Load Balancer Controller
      if: ${{ parameters.enableAwsAlbController }}
      action: fetch:template
      input:
        url: ./templates/addons-operations/aws/aws-load-balancer-controller/
        targetPath: ./repo/bootstraps/control-plane/addons/aws/
        values:
          projectName: ${{ parameters.repositoryPicker | parseRepoUrl | pick('repo') }}
          repoOwner: ${{ parameters.repositoryPicker | parseRepoUrl | pick('owner') }}

    - id: fetch-ingress-nginx
      name: Adicionar Ingress NGINX
      if: ${{ parameters.enableIngressNginx }}
      action: fetch:template
      input:
        url: ./templates/addons-operations/oss/ingress-nginx/
        targetPath: ./repo/bootstraps/control-plane/addons/oss/
        values:
          projectName: ${{ parameters.repositoryPicker | parseRepoUrl | pick('repo') }}
          repoOwner: ${{ parameters.repositoryPicker | parseRepoUrl | pick('owner') }}

    - id: fetch-argocd-ingress
      name: Adicionar ArgoCD Ingress
      if: ${{ parameters.enableArgoCdIngress }}
      action: fetch:template
      input:
        url: ./templates/addons-operations/oss/argocd-ingress/
        targetPath: ./repo/bootstraps/control-plane/addons/oss/
        values:
          projectName: ${{ parameters.repositoryPicker | parseRepoUrl | pick('repo') }}
          repoOwner: ${{ parameters.repositoryPicker | parseRepoUrl | pick('owner') }}

    - id: fetch-crossplane
      name: Adicionar Crossplane
      if: ${{ parameters.enableCrossplane }}
      action: fetch:template
      input:
        url: ./templates/addons-operations/oss/crossplane/
        targetPath: ./repo/bootstraps/control-plane/addons/oss/
        values:
          projectName: ${{ parameters.repositoryPicker | parseRepoUrl | pick('repo') }}
          repoOwner: ${{ parameters.repositoryPicker | parseRepoUrl | pick('owner') }}

    - id: fetch-karpenter
      name: Adicionar Karpenter
      if: ${{ parameters.enableKarpenter }}
      action: fetch:template
      input:
        url: ./templates/addons-operations/oss/karpenter/
        targetPath: ./repo/bootstraps/control-plane/addons/oss/
        values:
          projectName: ${{ parameters.repositoryPicker | parseRepoUrl | pick('repo') }}
          repoOwner: ${{ parameters.repositoryPicker | parseRepoUrl | pick('owner') }}

    - id: fetch-kube-prometheus-stack
      name: Adicionar Kube Prometheus Stack
      if: ${{ parameters.enableKubePrometheusStack }}
      action: fetch:template
      input:
        url: ./templates/addons-operations/oss/kube-prometheus-stack/
        targetPath: ./repo/bootstraps/control-plane/addons/oss/
        values:
          projectName: ${{ parameters.repositoryPicker | parseRepoUrl | pick('repo') }}
          repoOwner: ${{ parameters.repositoryPicker | parseRepoUrl | pick('owner') }}

    - id: fetch-metrics-server
      name: Adicionar Metrics Server
      if: ${{ parameters.enableMetricsServer }}
      action: fetch:template
      input:
        url: ./templates/addons-operations/oss/metrics-server/
        targetPath: ./repo/bootstraps/control-plane/addons/oss/
        values:
          projectName: ${{ parameters.repositoryPicker | parseRepoUrl | pick('repo') }}
          repoOwner: ${{ parameters.repositoryPicker | parseRepoUrl | pick('owner') }}

    # PUBLICAR PR PARA PRIORIDADE CR√çTICA
    - id: publish-pr-critical
      name: Criar Pull Request (Prioridade Cr√≠tica)
      if: ${{ parameters.priority === 'critical' }}
      action: publish:github:pull-request
      input:
        repoUrl: ${{ parameters.repositoryPicker }}
        title: ${{ parameters.prTitle }}
        branchName: feature/addons-add-critical
        description: |
          ## üö® ADI√á√ÉO CR√çTICA - Addons GitOps

          **Opera√ß√£o:** Adi√ß√£o de addons
          **Prioridade:** CR√çTICA üö®
          **Solicitado via:** Backstage Scaffolder
          **Reposit√≥rio:** ${{ parameters.repositoryPicker | parseRepoUrl | pick('owner') }}/${{ parameters.repositoryPicker | parseRepoUrl | pick('repo') }}

          ### üì¶ Addons Adicionados:
          ${{ parameters.enableAwsAlbController ? '- ‚úÖ AWS Load Balancer Controller' : '' }}
          ${{ parameters.enableIngressNginx ? '- ‚úÖ Ingress NGINX' : '' }}
          ${{ parameters.enableArgoCdIngress ? '- ‚úÖ ArgoCD Ingress' : '' }}
          ${{ parameters.enableCrossplane ? '- ‚úÖ Crossplane' : '' }}
          ${{ parameters.enableKarpenter ? '- ‚úÖ Karpenter' : '' }}
          ${{ parameters.enableKubePrometheusStack ? '- ‚úÖ Kube Prometheus Stack' : '' }}
          ${{ parameters.enableMetricsServer ? '- ‚úÖ Metrics Server' : '' }}

          ### ‚ö†Ô∏è ATEN√á√ÉO - PRIORIDADE CR√çTICA:
          - Este PR requer aprova√ß√£o imediata
          - Mudan√ßas ser√£o aplicadas automaticamente pelo ArgoCD ap√≥s o merge
          - Monitorar cluster ap√≥s aplica√ß√£o

          ### üîç Checklist de Revis√£o:
          - [ ] Validar sintaxe YAML dos arquivos
          - [ ] Verificar compatibilidade com cluster existente
          - [ ] Confirmar configura√ß√µes de recursos (CPU/Memory)
          - [ ] Validar depend√™ncias entre addons

          ### üöÄ Pr√≥ximos Passos:
          1. Aprova√ß√£o imediata pelos revisores
          2. Merge autom√°tico ap√≥s aprova√ß√£o
          3. Monitoramento da sincroniza√ß√£o ArgoCD
          4. Valida√ß√£o da sa√∫de dos addons

        targetBranch: ${{ parameters.targetBranch }}
        sourcePath: ./repo
        reviewers: ${{ parameters.reviewers }}
        draft: false

    # PUBLICAR PR PARA OUTRAS PRIORIDADES
    - id: publish-pr-normal
      name: Criar Pull Request (Prioridade Normal)
      if: ${{ parameters.priority !== 'critical' }}
      action: publish:github:pull-request
      input:
        repoUrl: ${{ parameters.repositoryPicker }}
        title: ${{ parameters.prTitle }}
        branchName: feature/addons-add-${{ parameters.priority }}
        description: |
          ## ‚úÖ Adi√ß√£o de Addons GitOps

          **Opera√ß√£o:** Adi√ß√£o de addons
          **Prioridade:** ${{ parameters.priority }}
          **Solicitado via:** Backstage Scaffolder
          **Reposit√≥rio:** ${{ parameters.repositoryPicker | parseRepoUrl | pick('owner') }}/${{ parameters.repositoryPicker | parseRepoUrl | pick('repo') }}

          ### üì¶ Addons Adicionados:
          {% if parameters.enableAwsAlbController %}
          - ‚úÖ AWS Load Balancer Controller
          {% endif %}
          {% if parameters.enableIngressNginx %}
          - ‚úÖ Ingress NGINX
          {% endif %}
          {% if parameters.enableArgoCdIngress %}
          - ‚úÖ ArgoCD Ingress
          {% endif %}
          {% if parameters.enableCrossplane %}
          - ‚úÖ Crossplane
          {% endif %}
          {% if parameters.enableKarpenter %}
          - ‚úÖ Karpenter
          {% endif %}
          {% if parameters.enableKubePrometheusStack %}
          - ‚úÖ Kube Prometheus Stack
          {% endif %}
          {% if parameters.enableMetricsServer %}
          - ‚úÖ Metrics Server
          {% endif %}

          ### üîç Checklist de Revis√£o:
          - [ ] Validar sintaxe YAML dos arquivos
          - [ ] Verificar compatibilidade com cluster existente
          - [ ] Confirmar configura√ß√µes de recursos (CPU/Memory)
          - [ ] Validar depend√™ncias entre addons
          - [ ] Testar em ambiente de desenvolvimento (se aplic√°vel)

          ### üöÄ Pr√≥ximos Passos P√≥s-Merge:
          1. ArgoCD detectar√° automaticamente as mudan√ßas
          2. Monitorar logs de sincroniza√ß√£o no ArgoCD
          3. Validar sa√∫de dos addons no cluster
          4. Executar testes de conectividade (se aplic√°vel)

          ### üîÑ Rollback:
          Em caso de problemas, reverter este PR ou aplicar:
          ```bash
          kubectl delete -f <arquivo-addon-problem√°tico>
          ```

          ### üìã Informa√ß√µes T√©cnicas:
          - **Reposit√≥rio:** ${{ parameters.repositoryPicker | parseRepoUrl | pick('owner') }}/${{ parameters.repositoryPicker | parseRepoUrl | pick('repo') }}
          - **Branch Base:** ${{ parameters.targetBranch }}
          - **Revisores:** ${{ parameters.reviewers | join(', ') }}

        targetBranch: ${{ parameters.targetBranch }}
        sourcePath: ./repo
        reviewers: ${{ parameters.reviewers }}
        draft: ${{ parameters.createDraft }}

  output:
    links:
      - title: Ver Pull Request (Cr√≠tico)
        if: ${{ parameters.priority === 'critical' }}
        url: ${{ steps['publish-pr-critical'].output.remoteUrl }}
        icon: github
      - title: Ver Pull Request (Normal)
        if: ${{ parameters.priority !== 'critical' }}
        url: ${{ steps['publish-pr-normal'].output.remoteUrl }}
        icon: github
    text:
      - title: Pull Request Criado
        content: |
          ## üéâ Pull Request de Adi√ß√£o Criado com Sucesso!

          **Reposit√≥rio:** ${{ parameters.repositoryPicker | parseRepoUrl | pick('owner') }}/${{ parameters.repositoryPicker | parseRepoUrl | pick('repo') }}
          **Prioridade:** ${{ parameters.priority }}
          **Opera√ß√£o:** Adi√ß√£o de addons

          ### üìã Pr√≥ximos Passos:
          1. **Revis√£o:** Aguardar aprova√ß√£o dos revisores designados
          2. **Testes:** Executar valida√ß√µes autom√°ticas
          3. **Merge:** Ap√≥s aprova√ß√£o, realizar merge
          4. **Monitoramento:** Acompanhar sincroniza√ß√£o no ArgoCD

          ### üîß Addons Adicionados:
          {% if parameters.enableAwsAlbController %}
          - ‚úÖ AWS Load Balancer Controller
          {% endif %}
          {% if parameters.enableIngressNginx %}
          - ‚úÖ Ingress NGINX
          {% endif %}
          {% if parameters.enableArgoCdIngress %}
          - ‚úÖ ArgoCD Ingress
          {% endif %}
          {% if parameters.enableCrossplane %}
          - ‚úÖ Crossplane
          {% endif %}
          {% if parameters.enableKarpenter %}
          - ‚úÖ Karpenter
          {% endif %}
          {% if parameters.enableKubePrometheusStack %}
          - ‚úÖ Kube Prometheus Stack
          {% endif %}
          {% if parameters.enableMetricsServer %}
          - ‚úÖ Metrics Server
          {% endif %}

          ### ‚ö†Ô∏è Importante:
          - Este PR adiciona novos addons ao cluster
          - Mudan√ßas ser√£o aplicadas automaticamente pelo ArgoCD ap√≥s o merge
          - Em caso de problemas, utilize o processo de rollback documentado

          ### üîó Links √öteis:
          - [Documenta√ß√£o ArgoCD](https://argo-cd.readthedocs.io/)
          - [Guia de Troubleshooting](https://your-docs.com/troubleshooting)
          - [Processo de Rollback](https://your-docs.com/rollback)
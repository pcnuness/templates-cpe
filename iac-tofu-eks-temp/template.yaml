apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: opentofu-eks-autopilot-8
  title: OpenTofu EKS Cluster com Pipeline Autopilot -8
  description: |
    Template para cria√ß√£o de clusters EKS usando OpenTofu com pipeline autopilot.
    Suporta m√∫ltiplos ambientes (dev, stage, prod) com tfvars espec√≠ficos.
  tags:
    - opentofu
    - terraform
    - eks
    - kubernetes
    - aws
    - gitops
    - argocd
    - infrastructure
    - autopilot
  links:
    - url: https://opentofu.org/docs/
      title: OpenTofu Documentation
      icon: docs
    - url: https://aws.amazon.com/eks/
      title: Amazon EKS
      icon: cloud

spec:
  owner: platform-team
  type: infrastructure
  
  parameters:
    # ===== CONFIGURA√á√ïES PRINCIPAIS =====
    - title: üèóÔ∏è Configura√ß√µes Principais
      required:
        - projectName
        - owner
        - awsRegion
        - environments
      properties:
        projectName:
          title: Nome do Reposit√≥rio
          type: string
          description: Nome do reposit√≥rio a ser criado
          default: meu-cluster-gitops
          pattern: '^[a-zA-Z0-9-_]+$'
        owner:
          title: Organiza√ß√£o ou Usu√°rio GitHub
          type: string
          description: Organiza√ß√£o ou usu√°rio GitHub que ser√° propriet√°rio do reposit√≥rio
          default: pcnuness
          pattern: '^[a-zA-Z0-9-_]+$'

        awsRegion:
          title: Regi√£o AWS
          type: string
          description: Regi√£o AWS para deploy da infraestrutura
          default: us-east-1
          enum:
            - us-east-1
            - us-west-2
            - eu-west-1
            - eu-central-1
            - ap-southeast-1
          enumNames:
            - 'US East (N. Virginia)'
            - 'US West (Oregon)'
            - 'Europe (Ireland)'
            - 'Europe (Frankfurt)'
            - 'Asia Pacific (Singapore)'

        environments:
          title: Selecione os ambientes que ser√£o configurados
          properties:
            enabledDev:
              title: Ambiente Develop
              type: boolean
              description: Habilitar Develop
              default: true
            enabledStage:
              title: Ambiente Stage
              type: boolean
              description: Habilitar Stage
              default: false
            enabledProd:
              title: Ambiente Production
              type: boolean
              description: Habilitar Production
              default: false

    # ===== CONFIGURA√á√ïES DO CLUSTER EKS =====
    - title: ‚öôÔ∏è Configura√ß√µes do Cluster EKS
      required:
        - clusterVersion
      properties:
        clusterVersion:
          title: Vers√£o do Kubernetes
          type: string
          description: Vers√£o do Kubernetes para o cluster EKS
          default: "1.31"
          enum:
            - "1.29"
            - "1.30"
            - "1.31"
            - "1.32"

    # ===== ADDONS E COMPONENTES =====
    - title: üîß Addons e Componentes
      properties:
        enabledCoreDns:
          title: Addon Core DNS
          type: boolean
          description: Habilitar Core DNS
          default: true
        enabledKubeProxy:
          title: Addon Kube Proxy
          type: boolean
          description: Habilitar Kube Proxy
          default: false
        enabledPodIdentityAgent:
          title: Addon AWS Pod Identity Agent
          type: boolean
          description: Habilitar Pod Identity Agent
          default: false
        enabledEbsCsiDriver:
          title: Addon AWS EBS CSI Driver
          type: boolean
          description: Habilitar WS EBS CSI Driver
          default: false

    # ===== CONFIGURA√á√ïES DE GOVERNAN√áA =====
    - title: üìã Configura√ß√µes de Governan√ßa
      properties:
        priority:
          title: Prioridade da Solicita√ß√£o
          type: string
          description: Prioridade para aprova√ß√£o e processamento
          default: medium
          enum:
            - low
            - medium
            - high
            - critical
          enumNames:
            - 'Baixa - Desenvolvimento/Teste'
            - 'M√©dia - Staging/QA'
            - 'Alta - Produ√ß√£o'
            - 'Cr√≠tica - Emerg√™ncia'

        reviewers:
          title: Revisores Adicionais
          type: array
          description: Usu√°rios GitHub para revisar o PR (al√©m dos padr√£o)
          items:
            type: string
          ui:help: 'Usernames do GitHub, um por linha'

        createDraft:
          title: Criar como Draft
          type: boolean
          description: Criar PR como draft para revis√£o antes da aprova√ß√£o
          default: false

  steps:
    # ===== VALIDA√á√ÉO INICIAL =====
    - id: validate-inputs
      name: üîç Validar Entradas
      action: debug:log
      input:
        message: |
          Validando configura√ß√µes:
          - Projeto: ${{ parameters.projectName }}
          - Owner: ${{ parameters.owner }}
          - Regi√£o: ${{ parameters.awsRegion }}
          - Cluster Version: ${{ parameters.clusterVersion }}
          - Ambientes:
              ${{ parameters.enabledProd}}
              ${{ parameters.enabledStage }}
              ${{ parameters.enabledDev }}
          - Addons: 
              ${{ parameters.enabledCoreDns }}
              ${{ parameters.enabledKubeProxy }} 
              {{ parameters.enabledPodIdentityAgent }}
              ${{ parameters.enabledEbsCsiDriver }}
        values:
          projectName: ${{ parameters.projectName }}
          owner: ${{ parameters.owner }}
          awsRegion: ${{ parameters.awsRegion }}
          clusterVersion: ${{ parameters.clusterVersion }}
          enabledProd: ${{ parameters.enabledProd }}
          enabledProd: ${{ parameters.enabledStage }}
          enabledProd: ${{ parameters.enabledDev }}
          enabledCoreDns: ${{ parameters.enabledCoreDns }}
          enabledKubeProxy: ${{ parameters.enabledKubeProxy }}
          enabledPodIdentityAgent: ${{ parameters.enabledPodIdentityAgent }}
          enabledEbsCsiDriver: ${{ parameters.enabledEbsCsiDriver }}

    # ===== FETCH ARQUIVOS EST√ÅTICOS =====
    - id: fetch-base-structure
      name: üìÅ Buscar Estrutura Base
      action: fetch:template
      input:
        url: ./templates/terraform/
        targetPath: ./terraform
        values:
          projectName: ${{ parameters.projectName }}
          owner: ${{ parameters.owner }}
          awsRegion: ${{ parameters.awsRegion }}
          clusterVersion: ${{ parameters.clusterVersion }}
          environments: ${{ parameters.environments }}
          enabledCoreDns: ${{ parameters.enabledCoreDns }}
          enabledKubeProxy: ${{ parameters.enabledKubeProxy }}
          enabledPodIdentityAgent: ${{ parameters.enabledPodIdentityAgent }}
          enabledEbsCsiDriver: ${{ parameters.enabledEbsCsiDriver }}

    # ===== CRIAR REPOSIT√ìRIO =====
    - id: publish-repo
      name: üì¶ Criar Reposit√≥rio
      action: publish:github
      input:
        repoUrl: github.com?owner=${{ parameters.owner }}&repo=${{ parameters.projectName }}
        description: 'Infraestrutura EKS para ${{ parameters.projectName }} usando OpenTofu'
        homepage: https://github.com/${{ values.owner }}/${{ values.projectName }}
        topics:
          - opentofu
          - terraform
          - eks
          - kubernetes
          - aws
          - infrastructure
          - ${{ parameters.projectName }}
        defaultBranch: main
        gitAuthorName: Backstage Scaffolder
        gitAuthorEmail: scaffolder@backstage.io
        repoVisibility: public
        gitCommitMessage: |
          üöÄ Initial commit: OpenTofu EKS Infrastructure for ${{ parameters.projectName }}

          - Configura√ß√£o completa de cluster EKS
          - Pipeline autopilot com GitHub Actions
          - Suporte a m√∫ltiplos ambientes: ${{ parameters.environments | join(', ') }}
          - Regi√£o: ${{ parameters.awsRegion }}
          - Kubernetes: v${{ parameters.clusterVersion }}
          
          Criado via Backstage Scaffolder

    # ===== AGUARDAR PROPAGA√á√ÉO =====
    - id: wait-for-repo
      name: ‚è≥ Aguardar Propaga√ß√£o do Reposit√≥rio
      action: debug:log
      input:
        message: |
          ‚è≥ Aguardando propaga√ß√£o do reposit√≥rio no GitHub...
          Reposit√≥rio: https://github.com/${{ values.owner }}/${{ values.projectName }}.git
          
          Aguardando 10 segundos para garantir que os arquivos estejam dispon√≠veis via API...

    # ===== REGISTRAR NO CAT√ÅLOGO (COM RETRY) =====
    - id: register-catalog
      name: üìã Registrar no Cat√°logo
      action: catalog:register
      input:
        repoContentsUrl: ${{ steps['publish-repo'].output.repoContentsUrl }}
        catalogInfoPath: '/catalog-info.yaml'
        optional: true

  output:
    links:
      - title: üì¶ Ver Reposit√≥rio
        url: https://github.com/${{ values.owner }}/${{ values.projectName }}
        icon: github

      - title: üìä Pipeline Status
        url: https://github.com/${{ values.owner }}/${{ values.projectName }}/actions
        icon: github

      - title: üìã Registrar Manualmente no Cat√°logo
        url: /catalog-import
        icon: catalog

      - title: üìñ OpenTofu Documentation
        url: https://opentofu.org/docs/
        icon: docs

      - title: ‚òÅÔ∏è AWS EKS Console
        url: https://console.aws.amazon.com/eks/home?region=${{ parameters.awsRegion }}#/clusters
        icon: cloud

    text:
      - title: üéâ Infraestrutura OpenTofu Criada com Sucesso!
        content: |
          ## ‚úÖ Reposit√≥rio Criado:
          
          **Reposit√≥rio:** https://github.com/${{ values.owner }}/${{ values.projectName }}/actions
          
          ## üìã Registro no Cat√°logo:
          
          Se o registro autom√°tico falhou, voc√™ pode registrar manualmente:
          
          1. **Acesse:** [Catalog Import](/catalog-import)
          2. **Cole a URL:** `https://github.com/${{ values.owner }}/${{ values.projectName }}/actions/blob/main/catalog-info.yaml`
          3. **Clique em:** "Analyze"
          4. **Confirme:** "Import"
          
          ## üöÄ Pr√≥ximos Passos:
          
          ### 1. üì¶ Verificar Reposit√≥rio
          - Acesse o reposit√≥rio criado no GitHub
          - Verifique se todos os arquivos est√£o corretos
          
          ### 2. üöÄ Executar Pipeline
          - V√° para a aba Actions do reposit√≥rio
          - Execute a pipeline manualmente para o ambiente desejado:
            ```bash
            # Exemplo para ambiente dev
            gh workflow run "Deploy OpenTofu EKS" --field stage=dev --field action=plan
            ```
          
          ### 3. üîß Configura√ß√µes P√≥s-Deploy
          - Configure kubectl: `aws eks update-kubeconfig --region ${{ parameters.awsRegion }} --name ${{ parameters.projectName }}-eks`
          - Valide conectividade com o cluster
          - Configure aplica√ß√µes no ArgoCD (se habilitado)
          
          ## üìä Resumo da Configura√ß√£o:
          - **Projeto:** ${{ parameters.projectName }}
          - **Ambientes:** ${{ parameters.environments | join(', ') }}
          - **Regi√£o:** ${{ parameters.awsRegion }}
          - **Kubernetes:** v${{ parameters.clusterVersion }}
          ## üÜò Suporte:
          Em caso de d√∫vidas ou problemas, consulte a documenta√ß√£o ou entre em contato com a equipe de platform.
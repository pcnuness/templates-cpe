apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: opentofu-eks-autopilot-12
  title: OpenTofu EKS Cluster com Pipeline Autopilot -12
  description: |
    Template para cria√ß√£o de clusters EKS usando OpenTofu com pipeline autopilot.
    Suporta m√∫ltiplos ambientes (dev, stage, prod) com tfvars espec√≠ficos.
  tags:
    - opentofu
    - terraform
    - eks
    - kubernetes
    - aws
    - gitops
    - argocd
    - infrastructure
    - autopilot

spec:
  owner: platform-team
  type: infrastructure
  
  parameters:
    # ===== CONFIGURA√á√ïES PRINCIPAIS =====
    - title: üèóÔ∏è Configura√ß√µes Principais
      required:
        - projectName
        - owner
        - awsRegion
      properties:
        projectName:
          title: Nome do Reposit√≥rio
          type: string
          description: Nome do reposit√≥rio a ser criado
          default: meu-cluster-gitops
          pattern: '^[a-zA-Z0-9-_]+$'
        
        owner:
          title: Organiza√ß√£o ou Usu√°rio GitHub
          type: string
          description: Organiza√ß√£o ou usu√°rio GitHub que ser√° propriet√°rio do reposit√≥rio
          default: pcnuness
          pattern: '^[a-zA-Z0-9-_]+$'

        awsRegion:
          title: Regi√£o AWS
          type: string
          description: Regi√£o AWS para deploy da infraestrutura
          default: us-east-1
          enum:
            - us-east-1
            - us-west-2
            - eu-west-1
            - eu-central-1
            - ap-southeast-1
          enumNames:
            - 'US East (N. Virginia)'
            - 'US West (Oregon)'
            - 'Europe (Ireland)'
            - 'Europe (Frankfurt)'
            - 'Asia Pacific (Singapore)'

    # ===== CONFIGURA√á√ïES DE AMBIENTES =====
    - title: üåç Configura√ß√µes de Ambientes
      properties:
        environments:
          title: Selecione os ambientes que ser√£o configurados
          type: object
          properties:
            enabledDev:
              title: Ambiente Development
              type: boolean
              description: Habilitar ambiente de desenvolvimento
              default: true
            enabledStage:
              title: Ambiente Staging
              type: boolean
              description: Habilitar ambiente de staging
              default: false
            enabledProd:
              title: Ambiente Production
              type: boolean
              description: Habilitar ambiente de produ√ß√£o
              default: false

    # ===== CONFIGURA√á√ïES DO CLUSTER EKS =====
    - title: ‚öôÔ∏è Configura√ß√µes do Cluster EKS
      required:
        - clusterVersion
      properties:
        clusterVersion:
          title: Vers√£o do Kubernetes
          type: string
          description: Vers√£o do Kubernetes para o cluster EKS
          default: "1.31"
          enum:
            - "1.29"
            - "1.30"
            - "1.31"
            - "1.32"

    # ===== ADDONS E COMPONENTES =====
    - title: üîß Addons e Componentes
      properties:
        enabledCoreDns:
          title: Addon Core DNS
          type: boolean
          description: Habilitar Core DNS
          default: true
        enabledKubeProxy:
          title: Addon Kube Proxy
          type: boolean
          description: Habilitar Kube Proxy
          default: false
        enabledPodIdentityAgent:
          title: Addon AWS Pod Identity Agent
          type: boolean
          description: Habilitar Pod Identity Agent
          default: false
        enabledEbsCsiDriver:
          title: Addon AWS EBS CSI Driver
          type: boolean
          description: Habilitar AWS EBS CSI Driver
          default: false

  steps:
    # ===== VALIDA√á√ÉO INICIAL =====
    - id: validate-inputs
      name: üîç Validar Entradas
      action: debug:log
      input:
        message: |
          Validando configura√ß√µes:
          - Projeto: ${{ parameters.projectName }}
          - Owner: ${{ parameters.owner }}
          - Regi√£o: ${{ parameters.awsRegion }}
          - Cluster Version: ${{ parameters.clusterVersion }}
          - Ambientes:
              Dev: ${{ parameters.environments.enabledDev }}
              Stage: ${{ parameters.environments.enabledStage }}
              Prod: ${{ parameters.environments.enabledProd }}
          - Addons: 
              CoreDNS: ${{ parameters.enabledCoreDns }}
              KubeProxy: ${{ parameters.enabledKubeProxy }}
              PodIdentityAgent: ${{ parameters.enabledPodIdentityAgent }}
              EbsCsiDriver: ${{ parameters.enabledEbsCsiDriver }}

    # ===== CRIAR ESTRUTURA BASE =====
    - id: fetch-base-structure
      name: üìÅ Criar Estrutura Base do Projeto
      action: fetch:template
      input:
        url: ./templates/terraform
        targetPath: ./terraform/
        values:
          projectName: ${{ parameters.projectName }}
          owner: ${{ parameters.owner }}
          awsRegion: ${{ parameters.awsRegion }}
          clusterVersion: ${{ parameters.clusterVersion }}
          # Ambientes
          enabledDev: ${{ parameters.environments.enabledDev }}
          enabledStage: ${{ parameters.environments.enabledStage }}
          enabledProd: ${{ parameters.environments.enabledProd }}
          # Addons
          enabledCoreDns: ${{ parameters.enabledCoreDns }}
          enabledKubeProxy: ${{ parameters.enabledKubeProxy }}
          enabledPodIdentityAgent: ${{ parameters.enabledPodIdentityAgent }}
          enabledEbsCsiDriver: ${{ parameters.enabledEbsCsiDriver }}

    # ===== CRIAR CONFIGURA√á√ïES POR AMBIENTE =====
    - id: create-environment-prod
      name: üåç Criar Configura√ß√µes por Ambiente
      action: fetch:template
      if: ${{ parameters.environments.enabledProd }}
      input:
        url: ./skeleton/environments/prod.tfvars
        targetPath: ./terraform/environments/prod.tfvars
        values:
          projectName: ${{ parameters.projectName }}
          awsRegion: ${{ parameters.awsRegion }}
          clusterVersion: ${{ parameters.clusterVersion }}
          enabledProd: ${{ parameters.environments.enabledProd }}
    
    # ===== CRIAR CONFIGURA√á√ïES POR AMBIENTE =====
    - id: create-environment-stage
      name: üåç Criar Configura√ß√µes por Ambiente
      action: fetch:template
      if: ${{ parameters.environments.enabledStage }}
      input:
        url: ./skeleton/environments/stage.tfvars
        targetPath: ./terraform/environments/stage.tfvars
        values:
          projectName: ${{ parameters.projectName }}
          awsRegion: ${{ parameters.awsRegion }}
          clusterVersion: ${{ parameters.clusterVersion }}
          enabledStage: ${{ parameters.environments.enabledStage }}
    
    # ===== CRIAR CONFIGURA√á√ïES POR AMBIENTE =====
    - id: create-environment-configs
      name: üåç Criar Configura√ß√µes por Ambiente
      action: fetch:template
      if: ${{ parameters.environments.enabledDev }}
      input:
        url: ./skeleton/environments/dev.tfvars
        targetPath: ./terraform/environments/dev.tfvars
        values:
          projectName: ${{ parameters.projectName }}
          awsRegion: ${{ parameters.awsRegion }}
          clusterVersion: ${{ parameters.clusterVersion }}
          enabledDev: ${{ parameters.environments.enabledDev }}

    # ===== CRIAR REPOSIT√ìRIO =====
    - id: publish-repo
      name: üì¶ Criar Reposit√≥rio
      action: publish:github
      input:
        repoUrl: "github.com?owner=${{ parameters.owner }}&repo=${{ parameters.projectName }}"
        description: 'Infraestrutura EKS para ${{ parameters.projectName }} usando OpenTofu'
        topics:
          - opentofu
          - terraform
          - eks
          - kubernetes
          - aws
          - infrastructure
          - ${{ parameters.projectName }}
        defaultBranch: main
        gitAuthorName: Backstage Scaffolder
        gitAuthorEmail: scaffolder@backstage.io
        repoVisibility: public
        gitCommitMessage: |
          üöÄ Initial commit: OpenTofu EKS Infrastructure for ${{ parameters.projectName }}
          
          - Configura√ß√£o completa de cluster EKS
          - Pipeline autopilot com GitHub Actions
          - Suporte a m√∫ltiplos ambientes
          - Regi√£o: ${{ parameters.awsRegion }}
          - Kubernetes: v${{ parameters.clusterVersion }}
          
          Criado via Backstage Scaffolder

    # ===== REGISTRAR NO CAT√ÅLOGO =====
    - id: register-catalog
      name: üìã Registrar no Cat√°logo
      action: catalog:register
      input:
        repoContentsUrl: ${{ steps['publish-repo'].output.repoContentsUrl }}
        catalogInfoPath: '/catalog-info.yaml'
        optional: true

  output:
    links:
      - title: üì¶ Ver Reposit√≥rio
        url: ${{ steps['publish-repo'].output.remoteUrl }}
        icon: github

      - title: üìä Pipeline Status
        url: ${{ steps['publish-repo'].output.remoteUrl }}/actions
        icon: github

    text:
      - title: üéâ Infraestrutura OpenTofu Criada com Sucesso!
        content: |
          ## ‚úÖ Reposit√≥rio Criado:
          
          **Reposit√≥rio:** ${{ steps['publish-repo'].output.remoteUrl }}
          
          ## üìä Resumo da Configura√ß√£o:
          - **Projeto:** ${{ parameters.projectName }}
          - **Regi√£o:** ${{ parameters.awsRegion }}
          - **Kubernetes:** v${{ parameters.clusterVersion }}
          - **Ambientes Habilitados:**
            - Development: ${{ parameters.environments.enabledDev }}
            - Staging: ${{ parameters.environments.enabledStage }}
            - Production: ${{ parameters.environments.enabledProd }}
          - **Addons Habilitados:**
            - CoreDNS: ${{ parameters.enabledCoreDns }}
            - Kube-Proxy: ${{ parameters.enabledKubeProxy }}
            - Pod Identity Agent: ${{ parameters.enabledPodIdentityAgent }}
            - EBS CSI Driver: ${{ parameters.enabledEbsCsiDriver }}
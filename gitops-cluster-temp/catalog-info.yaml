apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: gerenciar-addons-gitops
  title: Gerenciar Addons GitOps - Adicionar/Remover
  description: Adiciona ou remove addons em reposit√≥rio GitOps existente via Pull Request
  tags:
    - kubernetes
    - gitops
    - addons
    - pull-request
spec:
  owner: plataforma-gitops
  type: service
  parameters:
    - title: Configura√ß√µes do Reposit√≥rio
      required:
        - repositoryUrl
        - operation
      properties:
        repositoryUrl:
          title: URL do Reposit√≥rio GitOps
          type: string
          description: URL completa do reposit√≥rio GitOps existente
          pattern: '^https://github\.com/[a-zA-Z0-9-_]+/[a-zA-Z0-9-_]+$'
        operation:
          title: Opera√ß√£o
          type: string
          description: Tipo de opera√ß√£o a ser realizada
          enum:
            - add
            - remove
          enumNames:
            - Adicionar Addons
            - Remover Addons
        targetBranch:
          title: Branch Base
          type: string
          description: Branch base para criar o PR
          default: main
        prTitle:
          title: T√≠tulo do Pull Request
          type: string
          description: T√≠tulo personalizado para o PR
          default: "feat: Atualiza√ß√£o de addons GitOps via Backstage"

    - title: Sele√ß√£o de Addons AWS
      properties:
        enableAwsAlbController:
          title: AWS Load Balancer Controller
          type: boolean
          description: AWS Application Load Balancer Controller
          default: false
        
    - title: Sele√ß√£o de Addons OSS
      properties:
        enableIngressNginx:
          title: Ingress NGINX
          type: boolean
          description: Ingress NGINX Controller
          default: false
        enableArgoCdIngress:
          title: ArgoCD Ingress
          type: boolean
          description: Configura√ß√£o de Ingress para ArgoCD
          default: false
        enableCrossplane:
          title: Crossplane
          type: boolean
          description: Crossplane para gerenciamento de infraestrutura
          default: false
        enableKarpenter:
          title: Karpenter
          type: boolean
          description: Karpenter para autoscaling de Nodes
          default: false
        enableKubePrometheusStack:
          title: Kube Prometheus Stack
          type: boolean
          description: Stack de monitoramento Prometheus
          default: false
        enableMetricsServer:
          title: Metrics Server
          type: boolean
          description: Metrics Server para monitoramento
          default: false

    - title: Configura√ß√µes de Aprova√ß√£o
      properties:
        requiresApproval:
          title: Requer Aprova√ß√£o
          type: boolean
          description: PR requer aprova√ß√£o antes do merge
          default: true
        reviewers:
          title: Revisores
          type: array
          description: Lista de usu√°rios/equipes para revisar o PR
          items:
            type: string
          default: ["@plataforma-gitops", "@devops-team"]
        priority:
          title: Prioridade
          type: string
          description: Prioridade da mudan√ßa
          enum:
            - low
            - medium
            - high
            - critical
          enumNames:
            - Baixa
            - M√©dia
            - Alta
            - Cr√≠tica
          default: medium
        createDraft:
          title: Criar como Draft
          type: boolean
          description: Criar PR como draft (exceto para prioridade cr√≠tica)
          default: true

  steps:
    - id: fetch-repository
      name: Clonar Reposit√≥rio Existente
      action: fetch:plain
      input:
        url: ${{ parameters.repositoryUrl }}
        targetPath: ./repo

    # STEPS PARA ADICIONAR ADDONS
    - id: fetch-aws-alb-controller
      name: Adicionar AWS Load Balancer Controller
      if: ${{ parameters.operation === 'add' and parameters.enableAwsAlbController }}
      action: fetch:template
      input:
        url: ./templates/addons-operations/aws/aws-load-balancer-controller/
        targetPath: ./repo/bootstraps/control-plane/addons/aws/
        values:
          projectName: ${{ parameters.repositoryUrl | parseRepoUrl | pick('repo') }}

    - id: fetch-ingress-nginx
      name: Adicionar Ingress NGINX
      if: ${{ parameters.operation === 'add' and parameters.enableIngressNginx }}
      action: fetch:template
      input:
        url: ./templates/addons-operations/oss/ingress-nginx/
        targetPath: ./repo/bootstraps/control-plane/addons/oss/
        values:
          projectName: ${{ parameters.repositoryUrl | parseRepoUrl | pick('repo') }}

    - id: fetch-argocd-ingress
      name: Adicionar ArgoCD Ingress
      if: ${{ parameters.operation === 'add' and parameters.enableArgoCdIngress }}
      action: fetch:template
      input:
        url: ./templates/addons-operations/oss/argocd-ingress/
        targetPath: ./repo/bootstraps/control-plane/addons/oss/
        values:
          projectName: ${{ parameters.repositoryUrl | parseRepoUrl | pick('repo') }}

    - id: fetch-crossplane
      name: Adicionar Crossplane
      if: ${{ parameters.operation === 'add' and parameters.enableCrossplane }}
      action: fetch:template
      input:
        url: ./templates/addons-operations/oss/crossplane/
        targetPath: ./repo/bootstraps/control-plane/addons/oss/
        values:
          projectName: ${{ parameters.repositoryUrl | parseRepoUrl | pick('repo') }}

    - id: fetch-karpenter
      name: Adicionar Karpenter
      if: ${{ parameters.operation === 'add' and parameters.enableKarpenter }}
      action: fetch:template
      input:
        url: ./templates/addons-operations/oss/karpenter/
        targetPath: ./repo/bootstraps/control-plane/addons/oss/
        values:
          projectName: ${{ parameters.repositoryUrl | parseRepoUrl | pick('repo') }}

    - id: fetch-kube-prometheus-stack
      name: Adicionar Kube Prometheus Stack
      if: ${{ parameters.operation === 'add' and parameters.enableKubePrometheusStack }}
      action: fetch:template
      input:
        url: ./templates/addons-operations/oss/kube-prometheus-stack/
        targetPath: ./repo/bootstraps/control-plane/addons/oss/
        values:
          projectName: ${{ parameters.repositoryUrl | parseRepoUrl | pick('repo') }}

    - id: fetch-metrics-server
      name: Adicionar Metrics Server
      if: ${{ parameters.operation === 'add' and parameters.enableMetricsServer }}
      action: fetch:template
      input:
        url: ./templates/addons-operations/oss/metrics-server/
        targetPath: ./repo/bootstraps/control-plane/addons/oss/
        values:
          projectName: ${{ parameters.repositoryUrl | parseRepoUrl | pick('repo') }}

    # STEPS PARA REMOVER ADDONS
    - id: remove-aws-alb-controller
      name: Remover AWS Load Balancer Controller
      if: ${{ parameters.operation === 'remove' and parameters.enableAwsAlbController }}
      action: fs:delete
      input:
        files:
          - ./repo/bootstraps/control-plane/addons/aws/appset-load-balancer-controller.yaml

    - id: remove-ingress-nginx
      name: Remover Ingress NGINX
      if: ${{ parameters.operation === 'remove' and parameters.enableIngressNginx }}
      action: fs:delete
      input:
        files:
          - ./repo/bootstraps/control-plane/addons/oss/appset-ingress-nginx.yaml

    - id: remove-argocd-ingress
      name: Remover ArgoCD Ingress
      if: ${{ parameters.operation === 'remove' and parameters.enableArgoCdIngress }}
      action: fs:delete
      input:
        files:
          - ./repo/bootstraps/control-plane/addons/oss/appset-argocd-ingress.yaml

    - id: remove-crossplane
      name: Remover Crossplane
      if: ${{ parameters.operation === 'remove' and parameters.enableCrossplane }}
      action: fs:delete
      input:
        files:
          - ./repo/bootstraps/control-plane/addons/oss/appset-crossplane.yaml
          - ./repo/bootstraps/control-plane/addons/oss/appset-crossplane-aws-upbound.yaml

    - id: remove-karpenter
      name: Remover Karpenter
      if: ${{ parameters.operation === 'remove' and parameters.enableKarpenter }}
      action: fs:delete
      input:
        files:
          - ./repo/bootstraps/control-plane/addons/oss/appset-karpenter.yaml

    - id: remove-kube-prometheus-stack
      name: Remover Kube Prometheus Stack
      if: ${{ parameters.operation === 'remove' and parameters.enableKubePrometheusStack }}
      action: fs:delete
      input:
        files:
          - ./repo/bootstraps/control-plane/addons/oss/appset-kube-prometheus-stack.yaml

    - id: remove-metrics-server
      name: Remover Metrics Server
      if: ${{ parameters.operation === 'remove' and parameters.enableMetricsServer }}
      action: fs:delete
      input:
        files:
          - ./repo/bootstraps/control-plane/addons/oss/appset-metrics-server.yaml

    # CRIAR DESCRI√á√ÉO DO PR USANDO FETCH:TEMPLATE
    - id: create-pr-description
      name: Gerar Descri√ß√£o do PR
      action: fetch:template
      input:
        url: ./templates/pr-description/
        targetPath: ./repo/
        values:
          operation: ${{ parameters.operation }}
          priority: ${{ parameters.priority }}
          enableAwsAlbController: ${{ parameters.enableAwsAlbController }}
          enableIngressNginx: ${{ parameters.enableIngressNginx }}
          enableArgoCdIngress: ${{ parameters.enableArgoCdIngress }}
          enableCrossplane: ${{ parameters.enableCrossplane }}
          enableKarpenter: ${{ parameters.enableKarpenter }}
          enableKubePrometheusStack: ${{ parameters.enableKubePrometheusStack }}
          enableMetricsServer: ${{ parameters.enableMetricsServer }}

    # PUBLICAR PR PARA PRIORIDADE CR√çTICA
    - id: publish-pr-critical
      name: Criar Pull Request (Prioridade Cr√≠tica)
      if: ${{ parameters.priority === 'critical' }}
      action: publish:github:pull-request
      input:
        repoUrl: ${{ parameters.repositoryUrl }}
        title: ${{ parameters.prTitle }}
        branchName: feature/addons-update-${{ '' | now }}
        description: |
          ## üö® ATUALIZA√á√ÉO CR√çTICA - Addons GitOps

          **Opera√ß√£o:** ${{ parameters.operation === 'add' ? 'Adi√ß√£o' : 'Remo√ß√£o' }} de addons
          **Prioridade:** CR√çTICA üö®
          **Solicitado via:** Backstage Scaffolder

          ### üì¶ Addons Afetados:
          {% if parameters.enableAwsAlbController %}
          - ${{ parameters.operation === 'add' ? '‚úÖ Adicionado' : '‚ùå Removido' }}: AWS Load Balancer Controller
          {% endif %}
          {% if parameters.enableIngressNginx %}
          - ${{ parameters.operation === 'add' ? '‚úÖ Adicionado' : '‚ùå Removido' }}: Ingress NGINX
          {% endif %}
          {% if parameters.enableArgoCdIngress %}
          - ${{ parameters.operation === 'add' ? '‚úÖ Adicionado' : '‚ùå Removido' }}: ArgoCD Ingress
          {% endif %}
          {% if parameters.enableCrossplane %}
          - ${{ parameters.operation === 'add' ? '‚úÖ Adicionado' : '‚ùå Removido' }}: Crossplane
          {% endif %}
          {% if parameters.enableKarpenter %}
          - ${{ parameters.operation === 'add' ? '‚úÖ Adicionado' : '‚ùå Removido' }}: Karpenter
          {% endif %}
          {% if parameters.enableKubePrometheusStack %}
          - ${{ parameters.operation === 'add' ? '‚úÖ Adicionado' : '‚ùå Removido' }}: Kube Prometheus Stack
          {% endif %}
          {% if parameters.enableMetricsServer %}
          - ${{ parameters.operation === 'add' ? '‚úÖ Adicionado' : '‚ùå Removido' }}: Metrics Server
          {% endif %}

          ### ‚ö†Ô∏è ATEN√á√ÉO - PRIORIDADE CR√çTICA:
          - Este PR requer aprova√ß√£o imediata
          - Mudan√ßas ser√£o aplicadas automaticamente pelo ArgoCD ap√≥s o merge
          - Monitorar cluster ap√≥s aplica√ß√£o

          ### üîç Checklist de Revis√£o:
          - [ ] Validar sintaxe YAML dos arquivos
          - [ ] Verificar compatibilidade com cluster existente
          - [ ] Confirmar configura√ß√µes de recursos (CPU/Memory)
          - [ ] Validar depend√™ncias entre addons

        targetBranch: ${{ parameters.targetBranch }}
        sourcePath: ./repo
        reviewers: ${{ parameters.reviewers }}
        draft: false

    # PUBLICAR PR PARA OUTRAS PRIORIDADES
    - id: publish-pr-normal
      name: Criar Pull Request (Prioridade Normal)
      if: ${{ parameters.priority !== 'critical' }}
      action: publish:github:pull-request
      input:
        repoUrl: ${{ parameters.repositoryUrl }}
        title: ${{ parameters.prTitle }}
        branchName: feature/addons-update-${{ '' | now }}
        description: |
          ## üîÑ Atualiza√ß√£o de Addons GitOps

          **Opera√ß√£o:** ${{ parameters.operation === 'add' ? 'Adi√ß√£o' : 'Remo√ß√£o' }} de addons
          **Prioridade:** ${{ parameters.priority }}
          **Solicitado via:** Backstage Scaffolder

          ### üì¶ Addons Afetados:
          {% if parameters.enableAwsAlbController %}
          - ${{ parameters.operation === 'add' ? '‚úÖ Adicionado' : '‚ùå Removido' }}: AWS Load Balancer Controller
          {% endif %}
          {% if parameters.enableIngressNginx %}
          - ${{ parameters.operation === 'add' ? '‚úÖ Adicionado' : '‚ùå Removido' }}: Ingress NGINX
          {% endif %}
          {% if parameters.enableArgoCdIngress %}
          - ${{ parameters.operation === 'add' ? '‚úÖ Adicionado' : '‚ùå Removido' }}: ArgoCD Ingress
          {% endif %}
          {% if parameters.enableCrossplane %}
          - ${{ parameters.operation === 'add' ? '‚úÖ Adicionado' : '‚ùå Removido' }}: Crossplane
          {% endif %}
          {% if parameters.enableKarpenter %}
          - ${{ parameters.operation === 'add' ? '‚úÖ Adicionado' : '‚ùå Removido' }}: Karpenter
          {% endif %}
          {% if parameters.enableKubePrometheusStack %}
          - ${{ parameters.operation === 'add' ? '‚úÖ Adicionado' : '‚ùå Removido' }}: Kube Prometheus Stack
          {% endif %}
          {% if parameters.enableMetricsServer %}
          - ${{ parameters.operation === 'add' ? '‚úÖ Adicionado' : '‚ùå Removido' }}: Metrics Server
          {% endif %}

          ### üîç Checklist de Revis√£o:
          - [ ] Validar sintaxe YAML dos arquivos
          - [ ] Verificar compatibilidade com cluster existente
          - [ ] Confirmar configura√ß√µes de recursos (CPU/Memory)
          - [ ] Validar depend√™ncias entre addons
          - [ ] Testar em ambiente de desenvolvimento (se aplic√°vel)

          ### üöÄ Pr√≥ximos Passos P√≥s-Merge:
          1. ArgoCD detectar√° automaticamente as mudan√ßas
          2. Monitorar logs de sincroniza√ß√£o no ArgoCD
          3. Validar sa√∫de dos addons no cluster
          4. Executar testes de conectividade (se aplic√°vel)

          ### üîÑ Rollback:
          Em caso de problemas, reverter este PR ou aplicar:
          ```bash
          kubectl delete -f <arquivo-addon-problem√°tico>
          ```

        targetBranch: ${{ parameters.targetBranch }}
        sourcePath: ./repo
        reviewers: ${{ parameters.reviewers }}
        draft: ${{ parameters.createDraft }}

  output:
    links:
      - title: Ver Pull Request (Cr√≠tico)
        if: ${{ parameters.priority === 'critical' }}
        url: ${{ steps['publish-pr-critical'].output.remoteUrl }}
        icon: github
      - title: Ver Pull Request (Normal)
        if: ${{ parameters.priority !== 'critical' }}
        url: ${{ steps['publish-pr-normal'].output.remoteUrl }}
        icon: github
    text:
      - title: Pull Request Criado
        content: |
          ## üéâ Pull Request Criado com Sucesso!

          **Prioridade:** ${{ parameters.priority }}
          **Opera√ß√£o:** ${{ parameters.operation === 'add' ? 'Adi√ß√£o' : 'Remo√ß√£o' }} de addons
          **Status:** ${{ parameters.priority === 'critical' ? 'Produ√ß√£o (Cr√≠tico)' : 'Draft/Revis√£o' }}

          ### üìã Pr√≥ximos Passos:
          1. **Revis√£o:** Aguardar aprova√ß√£o dos revisores designados
          2. **Testes:** Executar valida√ß√µes autom√°ticas (se configuradas)
          3. **Merge:** Ap√≥s aprova√ß√£o, realizar merge para aplicar mudan√ßas
          4. **Monitoramento:** Acompanhar sincroniza√ß√£o no ArgoCD

          ### üîß Addons Selecionados:
          {% if parameters.enableAwsAlbController %}
          - AWS Load Balancer Controller
          {% endif %}
          {% if parameters.enableIngressNginx %}
          - Ingress NGINX
          {% endif %}
          {% if parameters.enableArgoCdIngress %}
          - ArgoCD Ingress
          {% endif %}
          {% if parameters.enableCrossplane %}
          - Crossplane
          {% endif %}
          {% if parameters.enableKarpenter %}
          - Karpenter
          {% endif %}
          {% if parameters.enableKubePrometheusStack %}
          - Kube Prometheus Stack
          {% endif %}
          {% if parameters.enableMetricsServer %}
          - Metrics Server
          {% endif %}

          ### ‚ö†Ô∏è Importante:
          - Este PR modifica a configura√ß√£o de addons do cluster
          - Mudan√ßas ser√£o aplicadas automaticamente pelo ArgoCD ap√≥s o merge
          - Em caso de problemas, utilize o processo de rollback documentado
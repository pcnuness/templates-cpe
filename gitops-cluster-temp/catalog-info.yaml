apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: gerenciar-addons-gitops
  title: Gerenciar Addons GitOps - Adicionar/Remover
  description: Adiciona ou remove addons em repositório GitOps existente via Pull Request
  tags:
    - kubernetes
    - gitops
    - addons
    - pull-request
spec:
  owner: plataforma-gitops
  type: service
  parameters:
    - title: Configurações do Repositório
      required:
        - repositoryUrl
        - operation
      properties:
        repositoryUrl:
          title: URL do Repositório GitOps
          type: string
          description: URL completa do repositório GitOps existente
          pattern: '^https://github\.com/[a-zA-Z0-9-_]+/[a-zA-Z0-9-_]+$'
        operation:
          title: Operação
          type: string
          description: Tipo de operação a ser realizada
          enum:
            - add
            - remove
          enumNames:
            - Adicionar Addons
            - Remover Addons
        targetBranch:
          title: Branch Base
          type: string
          description: Branch base para criar o PR
          default: main
        prTitle:
          title: Título do Pull Request
          type: string
          description: Título personalizado para o PR
          default: "feat: Atualização de addons GitOps via Backstage"

    - title: Seleção de Addons AWS
      properties:
        enableAwsAlbController:
          title: AWS Load Balancer Controller
          type: boolean
          description: AWS Application Load Balancer Controller
          default: false
        
    - title: Seleção de Addons OSS
      properties:
        enableIngressNginx:
          title: Ingress NGINX
          type: boolean
          description: Ingress NGINX Controller
          default: false
        enableArgoCdIngress:
          title: ArgoCD Ingress
          type: boolean
          description: Configuração de Ingress para ArgoCD
          default: false
        enableCrossplane:
          title: Crossplane
          type: boolean
          description: Crossplane para gerenciamento de infraestrutura
          default: false
        enableKarpenter:
          title: Karpenter
          type: boolean
          description: Karpenter para autoscaling de Nodes
          default: false
        enableKubePrometheusStack:
          title: Kube Prometheus Stack
          type: boolean
          description: Stack de monitoramento Prometheus
          default: false
        enableMetricsServer:
          title: Metrics Server
          type: boolean
          description: Metrics Server para monitoramento
          default: false

    - title: Configurações de Aprovação
      properties:
        requiresApproval:
          title: Requer Aprovação
          type: boolean
          description: PR requer aprovação antes do merge
          default: true
        reviewers:
          title: Revisores
          type: array
          description: Lista de usuários/equipes para revisar o PR
          items:
            type: string
          default: ["@plataforma-gitops", "@devops-team"]
        priority:
          title: Prioridade
          type: string
          description: Prioridade da mudança
          enum:
            - low
            - medium
            - high
            - critical
          enumNames:
            - Baixa
            - Média
            - Alta
            - Crítica
          default: medium
        createDraft:
          title: Criar como Draft
          type: boolean
          description: Criar PR como draft (exceto para prioridade crítica)
          default: true

  steps:
    - id: fetch-repository
      name: Clonar Repositório Existente
      action: fetch:plain
      input:
        url: ${{ parameters.repositoryUrl }}
        targetPath: ./repo

    # STEPS PARA ADICIONAR ADDONS
    - id: fetch-aws-alb-controller
      name: Adicionar AWS Load Balancer Controller
      if: ${{ parameters.operation === 'add' and parameters.enableAwsAlbController }}
      action: fetch:template
      input:
        url: ./templates/addons-operations/aws/aws-load-balancer-controller/
        targetPath: ./repo/bootstraps/control-plane/addons/aws/
        values:
          projectName: ${{ parameters.repositoryUrl | parseRepoUrl | pick('repo') }}

    - id: fetch-ingress-nginx
      name: Adicionar Ingress NGINX
      if: ${{ parameters.operation === 'add' and parameters.enableIngressNginx }}
      action: fetch:template
      input:
        url: ./templates/addons-operations/oss/ingress-nginx/
        targetPath: ./repo/bootstraps/control-plane/addons/oss/
        values:
          projectName: ${{ parameters.repositoryUrl | parseRepoUrl | pick('repo') }}

    - id: fetch-argocd-ingress
      name: Adicionar ArgoCD Ingress
      if: ${{ parameters.operation === 'add' and parameters.enableArgoCdIngress }}
      action: fetch:template
      input:
        url: ./templates/addons-operations/oss/argocd-ingress/
        targetPath: ./repo/bootstraps/control-plane/addons/oss/
        values:
          projectName: ${{ parameters.repositoryUrl | parseRepoUrl | pick('repo') }}

    - id: fetch-crossplane
      name: Adicionar Crossplane
      if: ${{ parameters.operation === 'add' and parameters.enableCrossplane }}
      action: fetch:template
      input:
        url: ./templates/addons-operations/oss/crossplane/
        targetPath: ./repo/bootstraps/control-plane/addons/oss/
        values:
          projectName: ${{ parameters.repositoryUrl | parseRepoUrl | pick('repo') }}

    - id: fetch-karpenter
      name: Adicionar Karpenter
      if: ${{ parameters.operation === 'add' and parameters.enableKarpenter }}
      action: fetch:template
      input:
        url: ./templates/addons-operations/oss/karpenter/
        targetPath: ./repo/bootstraps/control-plane/addons/oss/
        values:
          projectName: ${{ parameters.repositoryUrl | parseRepoUrl | pick('repo') }}

    - id: fetch-kube-prometheus-stack
      name: Adicionar Kube Prometheus Stack
      if: ${{ parameters.operation === 'add' and parameters.enableKubePrometheusStack }}
      action: fetch:template
      input:
        url: ./templates/addons-operations/oss/kube-prometheus-stack/
        targetPath: ./repo/bootstraps/control-plane/addons/oss/
        values:
          projectName: ${{ parameters.repositoryUrl | parseRepoUrl | pick('repo') }}

    - id: fetch-metrics-server
      name: Adicionar Metrics Server
      if: ${{ parameters.operation === 'add' and parameters.enableMetricsServer }}
      action: fetch:template
      input:
        url: ./templates/addons-operations/oss/metrics-server/
        targetPath: ./repo/bootstraps/control-plane/addons/oss/
        values:
          projectName: ${{ parameters.repositoryUrl | parseRepoUrl | pick('repo') }}

    # STEPS PARA REMOVER ADDONS
    - id: remove-aws-alb-controller
      name: Remover AWS Load Balancer Controller
      if: ${{ parameters.operation === 'remove' and parameters.enableAwsAlbController }}
      action: fs:delete
      input:
        files:
          - ./repo/bootstraps/control-plane/addons/aws/appset-load-balancer-controller.yaml

    - id: remove-ingress-nginx
      name: Remover Ingress NGINX
      if: ${{ parameters.operation === 'remove' and parameters.enableIngressNginx }}
      action: fs:delete
      input:
        files:
          - ./repo/bootstraps/control-plane/addons/oss/appset-ingress-nginx.yaml

    - id: remove-argocd-ingress
      name: Remover ArgoCD Ingress
      if: ${{ parameters.operation === 'remove' and parameters.enableArgoCdIngress }}
      action: fs:delete
      input:
        files:
          - ./repo/bootstraps/control-plane/addons/oss/appset-argocd-ingress.yaml

    - id: remove-crossplane
      name: Remover Crossplane
      if: ${{ parameters.operation === 'remove' and parameters.enableCrossplane }}
      action: fs:delete
      input:
        files:
          - ./repo/bootstraps/control-plane/addons/oss/appset-crossplane.yaml
          - ./repo/bootstraps/control-plane/addons/oss/appset-crossplane-aws-upbound.yaml

    - id: remove-karpenter
      name: Remover Karpenter
      if: ${{ parameters.operation === 'remove' and parameters.enableKarpenter }}
      action: fs:delete
      input:
        files:
          - ./repo/bootstraps/control-plane/addons/oss/appset-karpenter.yaml

    - id: remove-kube-prometheus-stack
      name: Remover Kube Prometheus Stack
      if: ${{ parameters.operation === 'remove' and parameters.enableKubePrometheusStack }}
      action: fs:delete
      input:
        files:
          - ./repo/bootstraps/control-plane/addons/oss/appset-kube-prometheus-stack.yaml

    - id: remove-metrics-server
      name: Remover Metrics Server
      if: ${{ parameters.operation === 'remove' and parameters.enableMetricsServer }}
      action: fs:delete
      input:
        files:
          - ./repo/bootstraps/control-plane/addons/oss/appset-metrics-server.yaml

    # CRIAR DESCRIÇÃO DO PR USANDO FETCH:TEMPLATE
    - id: create-pr-description
      name: Gerar Descrição do PR
      action: fetch:template
      input:
        url: ./templates/pr-description/
        targetPath: ./repo/
        values:
          operation: ${{ parameters.operation }}
          priority: ${{ parameters.priority }}
          enableAwsAlbController: ${{ parameters.enableAwsAlbController }}
          enableIngressNginx: ${{ parameters.enableIngressNginx }}
          enableArgoCdIngress: ${{ parameters.enableArgoCdIngress }}
          enableCrossplane: ${{ parameters.enableCrossplane }}
          enableKarpenter: ${{ parameters.enableKarpenter }}
          enableKubePrometheusStack: ${{ parameters.enableKubePrometheusStack }}
          enableMetricsServer: ${{ parameters.enableMetricsServer }}

    # PUBLICAR PR PARA PRIORIDADE CRÍTICA
    - id: publish-pr-critical
      name: Criar Pull Request (Prioridade Crítica)
      if: ${{ parameters.priority === 'critical' }}
      action: publish:github:pull-request
      input:
        repoUrl: ${{ parameters.repositoryUrl }}
        title: ${{ parameters.prTitle }}
        branchName: feature/addons-update-${{ '' | now }}
        description: |
          ## 🚨 ATUALIZAÇÃO CRÍTICA - Addons GitOps

          **Operação:** ${{ parameters.operation === 'add' ? 'Adição' : 'Remoção' }} de addons
          **Prioridade:** CRÍTICA 🚨
          **Solicitado via:** Backstage Scaffolder

          ### 📦 Addons Afetados:
          {% if parameters.enableAwsAlbController %}
          - ${{ parameters.operation === 'add' ? '✅ Adicionado' : '❌ Removido' }}: AWS Load Balancer Controller
          {% endif %}
          {% if parameters.enableIngressNginx %}
          - ${{ parameters.operation === 'add' ? '✅ Adicionado' : '❌ Removido' }}: Ingress NGINX
          {% endif %}
          {% if parameters.enableArgoCdIngress %}
          - ${{ parameters.operation === 'add' ? '✅ Adicionado' : '❌ Removido' }}: ArgoCD Ingress
          {% endif %}
          {% if parameters.enableCrossplane %}
          - ${{ parameters.operation === 'add' ? '✅ Adicionado' : '❌ Removido' }}: Crossplane
          {% endif %}
          {% if parameters.enableKarpenter %}
          - ${{ parameters.operation === 'add' ? '✅ Adicionado' : '❌ Removido' }}: Karpenter
          {% endif %}
          {% if parameters.enableKubePrometheusStack %}
          - ${{ parameters.operation === 'add' ? '✅ Adicionado' : '❌ Removido' }}: Kube Prometheus Stack
          {% endif %}
          {% if parameters.enableMetricsServer %}
          - ${{ parameters.operation === 'add' ? '✅ Adicionado' : '❌ Removido' }}: Metrics Server
          {% endif %}

          ### ⚠️ ATENÇÃO - PRIORIDADE CRÍTICA:
          - Este PR requer aprovação imediata
          - Mudanças serão aplicadas automaticamente pelo ArgoCD após o merge
          - Monitorar cluster após aplicação

          ### 🔍 Checklist de Revisão:
          - [ ] Validar sintaxe YAML dos arquivos
          - [ ] Verificar compatibilidade com cluster existente
          - [ ] Confirmar configurações de recursos (CPU/Memory)
          - [ ] Validar dependências entre addons

        targetBranch: ${{ parameters.targetBranch }}
        sourcePath: ./repo
        reviewers: ${{ parameters.reviewers }}
        draft: false

    # PUBLICAR PR PARA OUTRAS PRIORIDADES
    - id: publish-pr-normal
      name: Criar Pull Request (Prioridade Normal)
      if: ${{ parameters.priority !== 'critical' }}
      action: publish:github:pull-request
      input:
        repoUrl: ${{ parameters.repositoryUrl }}
        title: ${{ parameters.prTitle }}
        branchName: feature/addons-update-${{ '' | now }}
        description: |
          ## 🔄 Atualização de Addons GitOps

          **Operação:** ${{ parameters.operation === 'add' ? 'Adição' : 'Remoção' }} de addons
          **Prioridade:** ${{ parameters.priority }}
          **Solicitado via:** Backstage Scaffolder

          ### 📦 Addons Afetados:
          {% if parameters.enableAwsAlbController %}
          - ${{ parameters.operation === 'add' ? '✅ Adicionado' : '❌ Removido' }}: AWS Load Balancer Controller
          {% endif %}
          {% if parameters.enableIngressNginx %}
          - ${{ parameters.operation === 'add' ? '✅ Adicionado' : '❌ Removido' }}: Ingress NGINX
          {% endif %}
          {% if parameters.enableArgoCdIngress %}
          - ${{ parameters.operation === 'add' ? '✅ Adicionado' : '❌ Removido' }}: ArgoCD Ingress
          {% endif %}
          {% if parameters.enableCrossplane %}
          - ${{ parameters.operation === 'add' ? '✅ Adicionado' : '❌ Removido' }}: Crossplane
          {% endif %}
          {% if parameters.enableKarpenter %}
          - ${{ parameters.operation === 'add' ? '✅ Adicionado' : '❌ Removido' }}: Karpenter
          {% endif %}
          {% if parameters.enableKubePrometheusStack %}
          - ${{ parameters.operation === 'add' ? '✅ Adicionado' : '❌ Removido' }}: Kube Prometheus Stack
          {% endif %}
          {% if parameters.enableMetricsServer %}
          - ${{ parameters.operation === 'add' ? '✅ Adicionado' : '❌ Removido' }}: Metrics Server
          {% endif %}

          ### 🔍 Checklist de Revisão:
          - [ ] Validar sintaxe YAML dos arquivos
          - [ ] Verificar compatibilidade com cluster existente
          - [ ] Confirmar configurações de recursos (CPU/Memory)
          - [ ] Validar dependências entre addons
          - [ ] Testar em ambiente de desenvolvimento (se aplicável)

          ### 🚀 Próximos Passos Pós-Merge:
          1. ArgoCD detectará automaticamente as mudanças
          2. Monitorar logs de sincronização no ArgoCD
          3. Validar saúde dos addons no cluster
          4. Executar testes de conectividade (se aplicável)

          ### 🔄 Rollback:
          Em caso de problemas, reverter este PR ou aplicar:
          ```bash
          kubectl delete -f <arquivo-addon-problemático>
          ```

        targetBranch: ${{ parameters.targetBranch }}
        sourcePath: ./repo
        reviewers: ${{ parameters.reviewers }}
        draft: ${{ parameters.createDraft }}

  output:
    links:
      - title: Ver Pull Request (Crítico)
        if: ${{ parameters.priority === 'critical' }}
        url: ${{ steps['publish-pr-critical'].output.remoteUrl }}
        icon: github
      - title: Ver Pull Request (Normal)
        if: ${{ parameters.priority !== 'critical' }}
        url: ${{ steps['publish-pr-normal'].output.remoteUrl }}
        icon: github
    text:
      - title: Pull Request Criado
        content: |
          ## 🎉 Pull Request Criado com Sucesso!

          **Prioridade:** ${{ parameters.priority }}
          **Operação:** ${{ parameters.operation === 'add' ? 'Adição' : 'Remoção' }} de addons
          **Status:** ${{ parameters.priority === 'critical' ? 'Produção (Crítico)' : 'Draft/Revisão' }}

          ### 📋 Próximos Passos:
          1. **Revisão:** Aguardar aprovação dos revisores designados
          2. **Testes:** Executar validações automáticas (se configuradas)
          3. **Merge:** Após aprovação, realizar merge para aplicar mudanças
          4. **Monitoramento:** Acompanhar sincronização no ArgoCD

          ### 🔧 Addons Selecionados:
          {% if parameters.enableAwsAlbController %}
          - AWS Load Balancer Controller
          {% endif %}
          {% if parameters.enableIngressNginx %}
          - Ingress NGINX
          {% endif %}
          {% if parameters.enableArgoCdIngress %}
          - ArgoCD Ingress
          {% endif %}
          {% if parameters.enableCrossplane %}
          - Crossplane
          {% endif %}
          {% if parameters.enableKarpenter %}
          - Karpenter
          {% endif %}
          {% if parameters.enableKubePrometheusStack %}
          - Kube Prometheus Stack
          {% endif %}
          {% if parameters.enableMetricsServer %}
          - Metrics Server
          {% endif %}

          ### ⚠️ Importante:
          - Este PR modifica a configuração de addons do cluster
          - Mudanças serão aplicadas automaticamente pelo ArgoCD após o merge
          - Em caso de problemas, utilize o processo de rollback documentado